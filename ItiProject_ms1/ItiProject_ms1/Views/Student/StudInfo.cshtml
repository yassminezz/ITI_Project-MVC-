@model ItiProject_ms1.Views.ViewModel.StudentDetailsViewModel
@using System.Linq

@{
    ViewData["Title"] = "Student Profile";
    // NOTE: Ensure you have linked the Font Awesome CDN in your _Layout.cshtml file
}

<div class="container my-5">

    @* Display Status Messages (e.g., from successful password change) *@
    @if (!string.IsNullOrEmpty(TempData["SuccessMessage"] as string))
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }
    @if (!string.IsNullOrEmpty(TempData["ErrorMessage"] as string))
    {
        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
    }


    <div class="row">
        <div class="col-md-5">
            <div class="card shadow">
                <img src="@Model.Student.ImagePath"
                     class="card-img-top mx-auto mt-3 rounded-circle"
                     style="width: 150px; height: 150px; object-fit: cover;"
                     alt="Student Avatar"
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/150?text=No+Image';" />

                <div class="card-body text-center">
                    <h5 class="card-title text-primary">@Model.Student.Name</h5>
                    <p class="card-text text-muted">@Model.DepartmentName</p>
                </div>

                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>ID:</strong> @Model.Student.Id</li>
                    <li class="list-group-item"><strong>Grade:</strong> <span class="badge bg-success">@Model.Student.Grade</span></li>
                    <li class="list-group-item"><strong>Address:</strong> @Model.Student.Address</li>
                </ul>

                <div class="card-footer">
                    @if (User.IsInRole("Admin") || User.IsInRole("Hr"))
                    {
                        <a asp-action="ShowStuds" class="btn btn-secondary btn-sm">Back to List</a>
                        <a asp-action="UpdateStud" asp-route-id="@Model.Student.Id" class="btn btn-warning btn-sm float-end">Edit Profile</a>
                    }
                    @* Students typically don't see this footer on their own profile, 
                       or only see an Edit Profile link if allowed *
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h4>Account & Security Status</h4>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Account Linked?</dt>
                        <dd class="col-sm-8">
                            @if (Model.IsAccountLinked)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">No - Profile only</span>
                            }
                        </dd>

                        <dt class="col-sm-4">Login Username</dt>
                        <dd class="col-sm-8">@(Model.UserName ?? "N/A")</dd>

                        <dt class="col-sm-4">Assigned Role(s)</dt>
                        <dd class="col-sm-8">
                            @if (Model.Roles.Any())
                            {
                                @string.Join(", ", Model.Roles)
                            }
                            else
                            {
                                <span>(None assigned)</span>
                            }
                        </dd>
                        <dt class="col-sm-4">Identity GUID</dt>
                        <dd class="col-sm-8 text-monospace small">@Model.UserId</dd>
                    </dl>
                    
                    @* === ADDED: Password Change Link === *@
                    @if (Model.IsAccountLinked)
                    {
                        <div class="mt-4 pt-3 border-top">
                            <h5>Password Actions</h5>

                            @* Only show 'Change My Password' link to the Student looking at their OWN profile *@
                            @if (User.IsInRole("Student") && User.Identity.IsAuthenticated)
                            {
                                <a asp-action="ChangePassword"
                                   asp-controller="Student"
                                   class="btn btn-info">
                                    <i class="fas fa-lock me-1"></i> Change My Password
                                </a>
                            }

                            @* Admin/HR can see the list of accounts to perform administrative reset *@
                            @if (User.IsInRole("Admin") || User.IsInRole("Hr"))
                            {
                                <p class="text-muted small mt-2">
                                    Admins can manage passwords from the main student list.
                                </p>
                            }
                        </div>
                    }
                    @* ================================== *@
                </div>
            </div>
        </div>
    </div>
</div>